{"version":3,"file":"wait-file.esm.js","sources":["../src/index.ts"],"sourcesContent":["import fs from 'fs-extra';\r\nimport * as Joi from '@hapi/joi';\r\nimport Rx from 'rx';\r\n\r\nexport interface Opts {\r\n  resources: string[];\r\n  delay?: number;\r\n  interval?: number;\r\n  log?: boolean;\r\n  reverse?: boolean;\r\n  timeout?: number;\r\n  verbose?: boolean;\r\n  window?: number;\r\n}\r\n\r\ninterface File {\r\n  val: number;\r\n  data: Stats;\r\n}\r\n\r\ninterface Stats {\r\n  size: number;\r\n  [key: string]: any;\r\n}\r\n\r\ninterface Value {\r\n  [resource: string]: number;\r\n}\r\n\r\nconst WAIT_FILE_SCHEMA = Joi.object().keys({\r\n  resources: Joi.array()\r\n    .items(Joi.string().required())\r\n    .required(),\r\n  delay: Joi.number()\r\n    .integer()\r\n    .min(0)\r\n    .default(0),\r\n  interval: Joi.number()\r\n    .integer()\r\n    .min(0)\r\n    .default(250),\r\n  log: Joi.boolean().default(false),\r\n  reverse: Joi.boolean().default(false),\r\n  timeout: Joi.number()\r\n    .integer()\r\n    .min(0)\r\n    .default(Infinity),\r\n  verbose: Joi.boolean().default(false),\r\n  window: Joi.number()\r\n    .integer()\r\n    .min(0)\r\n    .default(750),\r\n});\r\n\r\nfunction waitFileImpl(oldOpts: Opts, cb: null | ((err?: Error) => any)) {\r\n  const validResult = Joi.validate(oldOpts, WAIT_FILE_SCHEMA);\r\n  if (validResult.error && cb) {\r\n    return cb(validResult.error);\r\n  }\r\n  const opts = validResult.value as Required<Opts>;\r\n\r\n  // it needs to be at least interval\r\n  if (opts.window < opts.interval) {\r\n    opts.window = opts.interval;\r\n  }\r\n\r\n  const output = opts.verbose ? console.log.bind(console) : function() {};\r\n\r\n  const log = opts.log ? console.log.bind(console) : function() {};\r\n\r\n  // the resources last known to be waiting for\r\n  let lastWaitForOutput: string;\r\n\r\n  let timeoutTimer: null | NodeJS.Timeout = null;\r\n  if (opts.timeout !== Infinity) {\r\n    timeoutTimer = setTimeout(function() {\r\n      log(\r\n        'wait-file(%s) timed out waiting for: %s; exiting with error',\r\n        process.pid,\r\n        lastWaitForOutput\r\n      );\r\n      cb && cb(new Error('Timeout'));\r\n    }, opts.timeout);\r\n  }\r\n\r\n  function cleanup(err?: Error) {\r\n    if (timeoutTimer) {\r\n      clearTimeout(timeoutTimer);\r\n      timeoutTimer = null;\r\n    }\r\n    if (cb) {\r\n      cb(err);\r\n      cb = null;\r\n    }\r\n  }\r\n\r\n  function createFile(file: string): Rx.Observable<File> {\r\n    const fstat = Rx.Observable.fromNodeCallback(fs.stat);\r\n    const source = (<unknown>fstat(file)) as Rx.Observable<Stats>;\r\n    const fakeStat = Rx.Observable.just({ size: -1 });\r\n    return Rx.Observable.catch(source, fakeStat).map(function(stat) {\r\n      return {\r\n        val: stat.size, // key comparator used\r\n        data: stat, // additional data for debugging\r\n      };\r\n    });\r\n  }\r\n\r\n  /* Stability checking occurs by using an Rx window,\r\n     It waits until all of the vals from the resources are >=0,\r\n     then it waits for a window which has no changes\r\n     (duplicate outputs are filtered by distinctUntilChanged)\r\n  */\r\n  let lastValues: Value | null = null;\r\n  const src = Rx.Observable.timer(opts.delay, opts.interval)\r\n    .concatMap(() => {\r\n      return Rx.Observable.from(opts.resources)\r\n        .concatMap(\r\n          function(resource: string) {\r\n            return createFile(resource);\r\n          },\r\n          function(resource: string, obj: File) {\r\n            return { resource: resource, val: obj.val, data: obj.data };\r\n          }\r\n        )\r\n        .reduce(function(acc: Value, x) {\r\n          acc[x.resource] = x.val;\r\n          return acc;\r\n        }, {});\r\n    })\r\n    .map(function(values: Value) {\r\n      lastValues = values; // save lastValues for later ref\r\n      return values;\r\n    })\r\n    .distinctUntilChanged()\r\n    .windowWithTime(opts.window);\r\n\r\n  function lastValuesAllAvailable(): boolean {\r\n    if (!lastValues) {\r\n      return false;\r\n    }\r\n    var notReady = opts.resources.filter(function(k) {\r\n      var lastValue = lastValues && lastValues[k];\r\n      var result = typeof lastValue !== 'number' || lastValue < 0;\r\n      return opts.reverse ? !result : result;\r\n    });\r\n\r\n    // only output when changes\r\n    var notReadyString = notReady.join(', ');\r\n    if (notReadyString && notReadyString !== lastWaitForOutput) {\r\n      log('wait-file(%s) waiting for: %s', process.pid, notReadyString);\r\n      lastWaitForOutput = notReadyString;\r\n    }\r\n\r\n    return !notReady.length;\r\n  }\r\n\r\n  let subsc = src.subscribe(\r\n    function(child) {\r\n      let childSub = child.toArray().subscribe(\r\n        function(x) {\r\n          output('child next', x);\r\n          if (lastValuesAllAvailable() && !x.length) {\r\n            output('stabilized');\r\n            log(\r\n              'wait-file(%s) exiting successfully found all: %s',\r\n              process.pid,\r\n              opts.resources.join(', ')\r\n            );\r\n            childSub.dispose();\r\n            subsc.dispose();\r\n            cleanup();\r\n          }\r\n        },\r\n        function(err) {\r\n          output('child err', err);\r\n        },\r\n        function() {\r\n          output('child complete');\r\n        }\r\n      );\r\n    },\r\n    function(err) {\r\n      output('err: ', err);\r\n      log('wait-file(%s) exiting with error', process.pid, err);\r\n      cleanup(err);\r\n    },\r\n    function() {\r\n      output('complete');\r\n      cleanup();\r\n    }\r\n  );\r\n}\r\n\r\nexport function waitFile(opts: Opts, cb?: (err?: Error) => any) {\r\n  if (cb && cb !== undefined) {\r\n    return waitFileImpl(opts, cb);\r\n  } else {\r\n    return new Promise((resolve, reject) => {\r\n      waitFileImpl(opts, err => {\r\n        if (err) {\r\n          reject(err);\r\n        } else {\r\n          resolve();\r\n        }\r\n      });\r\n    });\r\n  }\r\n}\r\n"],"names":["WAIT_FILE_SCHEMA","Joi","keys","resources","items","required","delay","integer","min","default","interval","log","reverse","timeout","Infinity","verbose","window","waitFileImpl","oldOpts","cb","validResult","error","opts","value","output","console","bind","lastWaitForOutput","timeoutTimer","setTimeout","process","pid","Error","cleanup","err","clearTimeout","createFile","file","fstat","Rx","Observable","fromNodeCallback","fs","stat","source","fakeStat","just","size","catch","map","val","data","lastValues","src","timer","concatMap","from","resource","obj","reduce","acc","x","values","distinctUntilChanged","windowWithTime","lastValuesAllAvailable","notReady","filter","k","lastValue","result","notReadyString","join","length","subsc","subscribe","child","childSub","toArray","dispose","waitFile","undefined","Promise","resolve","reject"],"mappings":";;;;AA6BA,MAAMA,gBAAgB;;AAAGC,MAAA,GAAaC,IAAb,CAAkB;EACzCC,SAAS;;EAAEF,KAAA,GACRG,KADQ,CACFH,MAAA,GAAaI,QAAb,EADE,EAERA,QAFQ,EAD8B;EAIzCC,KAAK;;EAAEL,MAAA,GACJM,OADI,GAEJC,GAFI,CAEA,CAFA,EAGJC,OAHI,CAGI,CAHJ,CAJkC;EAQzCC,QAAQ;;EAAET,MAAA,GACPM,OADO,GAEPC,GAFO,CAEH,CAFG,EAGPC,OAHO,CAGC,GAHD,CAR+B;EAYzCE,GAAG;;EAAEV,OAAA,GAAcQ,OAAd,CAAsB,KAAtB,CAZoC;EAazCG,OAAO;;EAAEX,OAAA,GAAcQ,OAAd,CAAsB,KAAtB,CAbgC;EAczCI,OAAO;;EAAEZ,MAAA,GACNM,OADM,GAENC,GAFM,CAEF,CAFE,EAGNC,OAHM,CAGEK,QAHF,CAdgC;EAkBzCC,OAAO;;EAAEd,OAAA,GAAcQ,OAAd,CAAsB,KAAtB,CAlBgC;EAmBzCO,MAAM;;EAAEf,MAAA,GACLM,OADK,GAELC,GAFK,CAED,CAFC,EAGLC,OAHK,CAGG,GAHH;CAnBe,CAAzB;;AAyBA,SAASQ,YAAT,CAAsBC,OAAtB,EAAqCC,EAArC;QACQC,WAAW,GAAGnB,QAAA,CAAaiB,OAAb,EAAsBlB,gBAAtB,CAApB;;MACIoB,WAAW,CAACC,KAAZ,IAAqBF,EAAzB,EAA6B;WACpBA,EAAE,CAACC,WAAW,CAACC,KAAb,CAAT;;;QAEIC,IAAI,GAAGF,WAAW,CAACG,KAAzB;;MAGID,IAAI,CAACN,MAAL,GAAcM,IAAI,CAACZ,QAAvB,EAAiC;IAC/BY,IAAI,CAACN,MAAL,GAAcM,IAAI,CAACZ,QAAnB;;;QAGIc,MAAM,GAAGF,IAAI,CAACP,OAAL,GAAeU,OAAO,CAACd,GAAR,CAAYe,IAAZ,CAAiBD,OAAjB,CAAf,GAA2C,cAA1D;QAEMd,GAAG,GAAGW,IAAI,CAACX,GAAL,GAAWc,OAAO,CAACd,GAAR,CAAYe,IAAZ,CAAiBD,OAAjB,CAAX,GAAuC,cAAnD;;MAGIE,iBAAJ;MAEIC,YAAY,GAA0B,IAA1C;;MACIN,IAAI,CAACT,OAAL,KAAiBC,QAArB,EAA+B;IAC7Bc,YAAY,GAAGC,UAAU,CAAC;MACxBlB,GAAG,CACD,6DADC,EAEDmB,OAAO,CAACC,GAFP,EAGDJ,iBAHC,CAAH;MAKAR,EAAE,IAAIA,EAAE,CAAC,IAAIa,KAAJ,CAAU,SAAV,CAAD,CAAR;KANuB,EAOtBV,IAAI,CAACT,OAPiB,CAAzB;;;WAUOoB,OAAT,CAAiBC,GAAjB;QACMN,YAAJ,EAAkB;MAChBO,YAAY,CAACP,YAAD,CAAZ;MACAA,YAAY,GAAG,IAAf;;;QAEET,EAAJ,EAAQ;MACNA,EAAE,CAACe,GAAD,CAAF;MACAf,EAAE,GAAG,IAAL;;;;WAIKiB,UAAT,CAAoBC,IAApB;UACQC,KAAK,GAAGC,EAAE,CAACC,UAAH,CAAcC,gBAAd,CAA+BC,EAAE,CAACC,IAAlC,CAAd;UACMC,MAAM,GAAaN,KAAK,CAACD,IAAD,CAA9B;UACMQ,QAAQ,GAAGN,EAAE,CAACC,UAAH,CAAcM,IAAd,CAAmB;MAAEC,IAAI,EAAE,CAAC;KAA5B,CAAjB;WACOR,EAAE,CAACC,UAAH,CAAcQ,KAAd,CAAoBJ,MAApB,EAA4BC,QAA5B,EAAsCI,GAAtC,CAA0C,UAASN,IAAT;aACxC;QACLO,GAAG,EAAEP,IAAI,CAACI,IADL;QAELI,IAAI,EAAER;OAFR;KADK,CAAP;;;;;;;;;MAaES,UAAU,GAAiB,IAA/B;QACMC,GAAG,GAAGd,EAAE,CAACC,UAAH,CAAcc,KAAd,CAAoBhC,IAAI,CAAChB,KAAzB,EAAgCgB,IAAI,CAACZ,QAArC,EACT6C,SADS,CACC;WACFhB,EAAE,CAACC,UAAH,CAAcgB,IAAd,CAAmBlC,IAAI,CAACnB,SAAxB,EACJoD,SADI,CAEH,UAASE,QAAT;aACSrB,UAAU,CAACqB,QAAD,CAAjB;KAHC,EAKH,UAASA,QAAT,EAA2BC,GAA3B;aACS;QAAED,QAAQ,EAAEA,QAAZ;QAAsBP,GAAG,EAAEQ,GAAG,CAACR,GAA/B;QAAoCC,IAAI,EAAEO,GAAG,CAACP;OAArD;KANC,EASJQ,MATI,CASG,UAASC,GAAT,EAAqBC,CAArB;MACND,GAAG,CAACC,CAAC,CAACJ,QAAH,CAAH,GAAkBI,CAAC,CAACX,GAApB;aACOU,GAAP;KAXG,EAYF,EAZE,CAAP;GAFQ,EAgBTX,GAhBS,CAgBL,UAASa,MAAT;IACHV,UAAU,GAAGU,MAAb;;WACOA,MAAP;GAlBQ,EAoBTC,oBApBS,GAqBTC,cArBS,CAqBM1C,IAAI,CAACN,MArBX,CAAZ;;WAuBSiD,sBAAT;QACM,CAACb,UAAL,EAAiB;aACR,KAAP;;;QAEEc,QAAQ,GAAG5C,IAAI,CAACnB,SAAL,CAAegE,MAAf,CAAsB,UAASC,CAAT;UAC/BC,SAAS,GAAGjB,UAAU,IAAIA,UAAU,CAACgB,CAAD,CAAxC;UACIE,MAAM,GAAG,OAAOD,SAAP,KAAqB,QAArB,IAAiCA,SAAS,GAAG,CAA1D;aACO/C,IAAI,CAACV,OAAL,GAAe,CAAC0D,MAAhB,GAAyBA,MAAhC;KAHa,CAAf;;QAOIC,cAAc,GAAGL,QAAQ,CAACM,IAAT,CAAc,IAAd,CAArB;;QACID,cAAc,IAAIA,cAAc,KAAK5C,iBAAzC,EAA4D;MAC1DhB,GAAG,CAAC,+BAAD,EAAkCmB,OAAO,CAACC,GAA1C,EAA+CwC,cAA/C,CAAH;MACA5C,iBAAiB,GAAG4C,cAApB;;;WAGK,CAACL,QAAQ,CAACO,MAAjB;;;MAGEC,KAAK,GAAGrB,GAAG,CAACsB,SAAJ,CACV,UAASC,KAAT;QACMC,QAAQ,GAAGD,KAAK,CAACE,OAAN,GAAgBH,SAAhB,CACb,UAASd,CAAT;MACErC,MAAM,CAAC,YAAD,EAAeqC,CAAf,CAAN;;UACII,sBAAsB,MAAM,CAACJ,CAAC,CAACY,MAAnC,EAA2C;QACzCjD,MAAM,CAAC,YAAD,CAAN;QACAb,GAAG,CACD,kDADC,EAEDmB,OAAO,CAACC,GAFP,EAGDT,IAAI,CAACnB,SAAL,CAAeqE,IAAf,CAAoB,IAApB,CAHC,CAAH;QAKAK,QAAQ,CAACE,OAAT;QACAL,KAAK,CAACK,OAAN;QACA9C,OAAO;;KAZE,EAeb,UAASC,GAAT;MACEV,MAAM,CAAC,WAAD,EAAcU,GAAd,CAAN;KAhBW,EAkBb;MACEV,MAAM,CAAC,gBAAD,CAAN;KAnBW,CAAf;GAFQ,EAyBV,UAASU,GAAT;IACEV,MAAM,CAAC,OAAD,EAAUU,GAAV,CAAN;IACAvB,GAAG,CAAC,kCAAD,EAAqCmB,OAAO,CAACC,GAA7C,EAAkDG,GAAlD,CAAH;IACAD,OAAO,CAACC,GAAD,CAAP;GA5BQ,EA8BV;IACEV,MAAM,CAAC,UAAD,CAAN;IACAS,OAAO;GAhCC,CAAZ;;;AAqCF,SAAgB+C,SAAS1D,MAAYH;MAC/BA,EAAE,IAAIA,EAAE,KAAK8D,SAAjB,EAA4B;WACnBhE,YAAY,CAACK,IAAD,EAAOH,EAAP,CAAnB;GADF,MAEO;WACE,IAAI+D,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV;MACjBnE,YAAY,CAACK,IAAD,EAAOY,GAAG;YAChBA,GAAJ,EAAS;UACPkD,MAAM,CAAClD,GAAD,CAAN;SADF,MAEO;UACLiD,OAAO;;OAJC,CAAZ;KADK,CAAP;;;;;;"}