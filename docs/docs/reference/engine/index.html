<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.66">
<title data-react-helmet="true">存储引擎 | LaserDB</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="存储引擎 | LaserDB"><meta data-react-helmet="true" name="description" content="对于 Laser 存储系统来说，主要的需求读写高性能、存储容量大以及可以支持批量导入。如果实现大容量存储肯定不能只是把数据存放到内存中，为了同时满足大容量存储和高性能读写的需求，最终在它们两个之间进行权衡"><meta data-react-helmet="true" property="og:description" content="对于 Laser 存储系统来说，主要的需求读写高性能、存储容量大以及可以支持批量导入。如果实现大容量存储肯定不能只是把数据存放到内存中，为了同时满足大容量存储和高性能读写的需求，最终在它们两个之间进行权衡"><meta data-react-helmet="true" property="og:url" content="https://your-docusaurus-test-site.com/docs/reference/engine"><link data-react-helmet="true" rel="shortcut icon" href="/img/small-logo.png"><link data-react-helmet="true" rel="canonical" href="https://your-docusaurus-test-site.com/docs/reference/engine"><link rel="stylesheet" href="/styles.a76e6df6.css">
<link rel="preload" href="/styles.4dd0e47f.js" as="script">
<link rel="preload" href="/runtime~main.89df429a.js" as="script">
<link rel="preload" href="/main.aaf1b95c.js" as="script">
<link rel="preload" href="/1.39450f4e.js" as="script">
<link rel="preload" href="/2.61f70580.js" as="script">
<link rel="preload" href="/42.eef7382e.js" as="script">
<link rel="preload" href="/43.a364796b.js" as="script">
<link rel="preload" href="/935f2afb.e5cff702.js" as="script">
<link rel="preload" href="/17896441.98d4f75d.js" as="script">
<link rel="preload" href="/dab48b36.3a186eaf.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.png" alt="My Site Logo"><strong class="navbar__title"></strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/">Next</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.png" alt="My Site Logo"><strong class="navbar__title"></strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link">Versions</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">LaserDB</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/getting-started">快速上手</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/comparison-to-alternatives">常见数据库对比</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">集群部署</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/cluster-deploy">集群部署</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/cluster-config">集群配置</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">生态工具</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/laser-client">Laser 客户端</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/laser-proxy">Laser Proxy</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/laser-transform">Laser Transform</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/monitor">监控告警</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">教程</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/xxx">Style Guide</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">参考指南</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/data-model">数据模型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/data-shard">数据分片</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/data-import">批量导入</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/reference/engine">存储引擎</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/server-config">Laser Server 配置</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/server-error-code">错误码</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/fqa">常见问题</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/terminology">术语表</a></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">存储引擎</h1></header><div class="markdown"><p>对于 Laser 存储系统来说，主要的需求读写高性能、存储容量大以及可以支持批量导入。如果实现大容量存储肯定不能只是把数据存放到内存中，为了同时满足大容量存储和高性能读写的需求，最终在它们两个之间进行权衡
选择 RocksDB 作为存储引擎，RocksDB 支持将数据落地到磁盘中可以有效的解决数据的容量问题，相比较内存数据库读写性能肯定要稍微差些，不过这个问题也不是没有补救的办法，比如 RocksDB 实现了 Write Buffer 来提升
写的性能，降低 IO 操作，通过实现 BlockCache 以及布隆过滤器来加速查找速度，可以有效的弥补读写性能问题。通过使用 RocksDB 存储引擎可以轻松的组织实现 TB 级别的高性能存储系统</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="使用"></a>使用<a aria-hidden="true" tabindex="-1" class="hash-link" href="#使用" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="资源共享"></a>资源共享<a aria-hidden="true" tabindex="-1" class="hash-link" href="#资源共享" title="Direct link to heading">#</a></h4><p>在数据分片章节介绍一个数据表存在多个表分区，一个数据分片中可能包含多个不同数据表分区。其中每个表分区真实物理的一一对应一个 RocksDB 实例，一个服务节点会存在多个 RocksDB 实例，RocksDB 通过对 Compaction 线程池、
Block Cache 共享可以实现单进程多实例运行。</p><p>默认情况下创建的 RocksDB 实例都会固定开辟一个 Cache 用来做 Block Data 的 Cache, 如果不进行 Cache 共享每个实例都会创建一个 Cache, 随着服务节点中映射的表分区越来越多，使用的内存也线性增长，最终程序由于没有内存
Core 掉。并且每个实例开固定的 Cache 不一定合理，由于 Cache 使用的是 LRU Cache, 有的数据表有大量的读操作 Cache 持续更新数据，有的数据表仅仅是某个时间内有读操作吧 Cache 占满后就再没有更新，这样严重的浪费
, 通过共享 Cache 可以有效的解决上述问题，每个服务节点开辟一个大的 Cache, 所有的数据表共享一个 Cache, 可以将内存使用量控制在一个水平上，并且提升 Cache 的利用率。</p><p>另外当 RocksDB 有写的操作时会首先将数据写到一个内存数据结构中，也称 MemTable。这个结构是从 Write Buffer 中申请内存使用，当 Writer Buffer 慢了就会触发后台 Flush 流程，同样默认情况下每个 RocksDB
实例都会创建一个专属的 Buffer 来提升写性能。为了很好的控制内存使用，我们将 Write Buffer 也进行了共享, Write Buffer 不用重新开辟内存空间，可以复用 BlockCache 的内存空间，当我们创建 WriteBuffer 对象的时候
可以指定在 BlockCache 中创建，这样我们仅需要每个服务节点控制一个 BlockCache 总体大小就是对应的内存的使用量</p><p>最终共享 BlockCache 和 Writer Buffer 方法如下</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// config 是服务节点的配置对象</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 计算 cache 的总体大小，与 write buffer 总体大小</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">uint64_t cache_size = static_cast&lt;uint64_t&gt;(config-&gt;getBlockCacheSizeGb()) * 1024 * 1024 * 1024;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">uint64_t write_buffer_size = static_cast&lt;uint64_t&gt;(config-&gt;getWriteBufferSizeGb()) * 1024 * 1024 * 1024;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">int32_t num_shard_bits = config-&gt;getNumShardBits();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">bool strict_capacity_limit = config-&gt;getStrictCapacityLimit();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">double high_pri_pool_ratio = config-&gt;getHighPriPoolRatio();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">auto cache = rocksdb::NewLRUCache(cache_size, num_shard_bits, strict_capacity_limit, high_pri_pool_ratio);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">LOG(INFO) &lt;&lt; &quot;Rocksdb block cache capacity size:&quot; &lt;&lt; cache_-&gt;GetCapacity() &lt;&lt; &quot; num shard bits:&quot; &lt;&lt; num_shard_bits</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          &lt;&lt; &quot; strict_capacity_limit:&quot; &lt;&lt; strict_capacity_limit &lt;&lt; &quot; high_pri_pool_ratio:&quot; &lt;&lt; high_pri_pool_ratio;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// write buffer 使用 block cache 的物理内存</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">auto write_buffer_manager = std::make_shared&lt;rocksdb::WriteBufferManager&gt;(write_buffer_size, cache_);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 构建 RocksDB::Options</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rocksdb::Options options;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rocksdb::BlockBasedTableOptions table_options;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">....</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">table_options.block_cache = cache;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">options.write_buffer_manager = write_buffer_manager;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">....</span></div></div></div></div></div><p>除了内存资源，对于线程资源 RocksDb 会创建一个单例的 Env 对象， Env 除了适配各种运行环境以外，还负责维护 RocksDB 后台的线程池，所有的 <code>rocksdb::Options</code> 创建都会使用默认的 Env 对象，意味着所有的
RocksDB 实例都是用同一个后台处理线程池，这样有效的降低线程数目，减少线程频繁切换的额外开销。当然根据实际的处理情况可以修改线程池的大小通过 <code>Env::SetBackgroundThreads</code> 接口。处理后台用于 Flush, Compaction 操作的
线程池外，每个 RocksDB 实例都需要 <code>rocksdb::SstFileManager</code> 来管理 SST 文件，每个对象中有一个独立的调度线程，这样在每次创建实例都会产生一个线程，随着实例数增加，线程数也在增加，Laser 通过所有实例共享 <code>rocksdb::SstFileManager</code>
对象的方式接受额外的线程创建，具体的方法是：</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">rocksdb::Option option;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">auto sst_file_manager = std::shared_ptr&lt;rocksdb::SstFileManager&gt;(rocksdb::NewSstFileManager(option.env, option.info_log));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">option.sst_file_manager = sst_file_manager;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">...</span></div></div></div></div></div><p>通过共享 SST 文件管理器可以避免创建大量的线程，不过在 RocksDB 还有两个额外的线程没有办法共享，在 RocksDB 实例创建成功后会通过 <code>DBImpl::StartTimedTasks</code> 分别创建 Dump 和持久化统计信息的两个线程，
这两个线程的工作就是定时将统计信息 dump 或者持久化, 对于多实例 RocksDB 统计信息通过在上层统一调用接口来实现统计信息获取，所以我们对 RocksDB 源码进行改造，去掉这两个定时任务，从而使得 RocksDB 实例自己不会额外
创建线程，单个服务节点的线程不会随着承载数据表个数的增多而增多。</p><table><thead><tr><th align="left">配置名称</th><th align="left">默认值</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">BlockCacheSizeGb</td><td align="left">2</td><td align="left">服务节点最大允许的内存缓存大小, 建议设置为系统内存 2/3</td></tr><tr><td align="left">HighPriPoolRatio</td><td align="left">0.5</td><td align="left">缓存池中高优先的 cache 比例</td></tr><tr><td align="left">StrictCapacityLimit</td><td align="left">true</td><td align="left">是否强制限制内存大小</td></tr><tr><td align="left">NumShardBits</td><td align="left">6</td><td align="left">Cache 分片使用的前缀位数，代表分片的个数</td></tr><tr><td align="left">WriteBufferSizeGb</td><td align="left">1</td><td align="left">写 Buffer 最大大小</td></tr></tbody></table><p>一般情况下只需要根据系统内存的大小调整 <code>BlockCacheSizeGb</code> 和 <code>WriteBufferSizeGb</code> 大小即可，其他参数可以不做调整</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="key-自动过期"></a>Key 自动过期<a aria-hidden="true" tabindex="-1" class="hash-link" href="#key-自动过期" title="Direct link to heading">#</a></h4><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="配置热更新"></a>配置热更新<a aria-hidden="true" tabindex="-1" class="hash-link" href="#配置热更新" title="Direct link to heading">#</a></h4><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="主要参数"></a>主要参数<a aria-hidden="true" tabindex="-1" class="hash-link" href="#主要参数" title="Direct link to heading">#</a></h3></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/reference/engine.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/reference/data-import"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 批量导入</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/reference/server-config"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Laser Server 配置 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#使用" class="table-of-contents__link">使用</a></li><li><a href="#主要参数" class="table-of-contents__link">主要参数</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">文档</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">关于 LaserDB</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started">快速上手</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/reference/data-model">参考指南</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright © 2021 LaserDB.</div></div></div></footer></div>
<script src="/styles.4dd0e47f.js"></script>
<script src="/runtime~main.89df429a.js"></script>
<script src="/main.aaf1b95c.js"></script>
<script src="/1.39450f4e.js"></script>
<script src="/2.61f70580.js"></script>
<script src="/42.eef7382e.js"></script>
<script src="/43.a364796b.js"></script>
<script src="/935f2afb.e5cff702.js"></script>
<script src="/17896441.98d4f75d.js"></script>
<script src="/dab48b36.3a186eaf.js"></script>
</body>
</html>